---
title: "ğŸ“º 6. ìŠ¤í”„ë§ DB ì ‘ê·¼ ê¸°ìˆ "
description: "ìŠ¤í”„ë§ ì…ë¬¸ ê°•ì˜ ì •ë¦¬"
date: 2022-01-12
update: 2022-01-12
tags:
  - Java
  - SpringBoot
series: "ğŸ“º ìŠ¤í”„ë§ ì…ë¬¸"
---

<em><strong>[ìŠ¤í”„ë§ ì…ë¬¸ - ì½”ë“œë¡œ ë°°ìš°ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸, ì›¹ MVC, DB ì ‘ê·¼ ê¸°ìˆ ](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%EC%9E%85%EB%AC%B8-%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8)ì„ ë“¤ìœ¼ë©° ì •ë¦¬í•˜ëŠ” POSTì…ë‹ˆë‹¤.</strong></em>

> **ì „ì²´ì ì¸ íë¦„**
> - Spring Project ìƒì„±
> - Spring bootë¡œ ì›¹ ì„œë²„ ì‹¤í–‰
> - íšŒì› ë„ë©”ì¸ ê°œë°œ
> - ì›¹ MVC ê°œë°œ
> - DB ì—°ë™ - JDBC, JPA, Spring data JPA
> - í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±

## ğŸ” H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜
ë©”ëª¨ë¦¬ ê¸°ë°˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì‹¤ë¬´ì—ì„œëŠ” ì‚¬ìš©ë  ìˆ˜ ì—†ë‹¤.
ìˆ˜ ë§ì€ ë°ì´í„°ë¥¼ ê¸°ë¡í•˜ê³  ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•´ì„œëŠ” Databaseë¥¼ ì‚¬ìš©í•˜ì—¬ì•¼ í•œë‹¤.

ì—¬ê¸°ì„œ ì‚¬ìš©í•  DatabaseëŠ” ì•„ì£¼ ê°€ë³ê³  ê°„ë‹¨í•œ **"H2 Database"** ë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤.

**H2 Database**ëŠ” ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì§•ì„ ê°€ì§„ë‹¤.
- open source, ë§¤ìš° ë¹ ë¥¸ JDBC API
- Embedded and server modes; disk-based or in-memory databases
- Browser ê¸°ë°˜ì˜ Console application
- íŠ¸ëœì­ì…˜ ì§€ì›, ë™ì‹œì„± ì œì–´ ê°€ëŠ¥
- Encrypted databases
- ODBC driver

### â› ì„¤ì¹˜
1. [H2 ê³µì‹ í™ˆí˜ì´ì§€](https://www.h2database.com/html/main.html)ì— ì ‘ì†í•˜ì—¬ 'All Platforms' ì„ ì„¤ì¹˜í•œë‹¤. (Windows í™˜ê²½ì¸ ê²½ìš°ì—ëŠ” Windowsë¥¼ ì„¤ì¹˜í•˜ë©´ ëœë‹¤.)
2. ì••ì¶•ì„ í•´ì œí•˜ê³  `Terminal` ì„ ì—´ì–´ `h2/bin` ìœ¼ë¡œ ì´ë™í•œë‹¤.
3. `chmod 755 h2.sh` ëª…ë ¹ì–´ë¡œ `h2.sh` ì— ëŒ€í•œ ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤. (MAC ìœ ì €ì˜ ê²½ìš°)
4. `./h2.sh` ë¡œ ì‹¤í–‰
<img src="https://images.velog.io/images/bsu1209/post/4694730f-34c9-4d77-991a-4fc493fe188c/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-01-07%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.11.15.png" width="80%">

5. "Browser ê¸°ë°˜ì˜ Console application"ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê²½ìš°ì— ë”°ë¼ ì ‘ì†ì´ ë˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ëŠ” **ë„ë©”ì¸ ì£¼ì†Œë§Œ localhost** ë¡œ ë³€ê²½í•˜ì—¬ ì ‘ì†í•œë‹¤. (ë’¤ì—ëŠ” ì„¸ì…˜í‚¤ê°€ í¬í•¨ë˜ì–´ ìˆì–´ ìˆ˜ì •í•˜ë©´ ì•ˆëœë‹¤.)
6. ìµœì´ˆì—ëŠ” **"Database File"** ì„ ìƒì„±í•´ì•¼ í•œë‹¤. ìœ„ í™”ë©´ì—ì„œ `ì—°ê²°` ì„ ëˆ„ë¥¸ë‹¤.
<img src="https://images.velog.io/images/bsu1209/post/2263829c-7b5e-4cc9-bb30-5963b85760aa/image.png" width="80%">

7. ì´í›„, `Terminal` ì„ ì¼œì„œ, `home` directoryì—ì„œ `ls -al`ë¡œ `test.mv.db` ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
8.  `test.mv.db` ì˜ ì¡´ì¬ë¥¼ í™•ì¸í•œ ì´í›„, ë‹¤ìŒì˜ ì ‘ê·¼ë¶€í„°ëŠ” ì´ì²˜ëŸ¼ íŒŒì¼ë¡œ ì ‘ê·¼í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ `JDBC URL:` ì— `jdbc:h2:tcp://localhost/~/test` ì„ ì…ë ¥í•˜ì—¬ socketìœ¼ë¡œ ì ‘ê·¼í•˜ë„ë¡ í•œë‹¤. 
> íŒŒì¼ë¡œ ì ‘ê·¼í•˜ê²Œ ë˜ë©´ applicationê³¼ web consoleì´ ë™ì‹œì— ì ‘ê·¼í–ˆì„ ë•Œ ì¶©ëŒì´ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
9. ì œëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ëŠ” `rm test.mv.db` ë¡œ íŒŒì¼ì„ ì§€ìš°ê³ , `h2.sh` ì„ ì¬ì‹œì‘í•˜ì—¬ ì²˜ìŒë¶€í„° ìˆ˜í–‰í•œë‹¤.

### â› Table ìƒì„±
êµ¬í˜„í–ˆë˜ `Member` domainê³¼ ë™ì¼í•˜ê²Œ tableì„ ìƒì„±í•œë‹¤.

```sql
create table member (
    id bigint generated by default as identity,
    name varchar(255),
    pwd integer,
    phone varchar(11),
    primary key (id)
);
```
<img src="https://images.velog.io/images/bsu1209/post/7b6bdc4c-9936-4830-b2a5-274710f13945/image.png" width="30%">

ìœ„ì™€ ê°™ì´ tableì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
ì´ë¥¼ ì´ì „ì— ìƒì„±í–ˆë˜ `domain/Member.java` ì˜ íƒ€ì…ê³¼ ë¹„êµí•´ë³´ë©´,

```java
private Long id; == (h2)bigint
private String name; == (h2)varchar
private int pwd; == (h2)integer
private String phone; == (h2)varchar
```

- ì—¬ê¸°ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ `id bigint generated by default as identity` ì¸ë°, ì´ëŠ” ê°’ì´ ì„¤ì •ë˜ì§€ ì•Šì€ ì±„ë¡œ INSERT ë˜ë©´, H2 DBê°€ **ìë™ìœ¼ë¡œ í•´ë‹¹ fieldì˜ ê°’ì„ í• ë‹¹**í•´ì¤€ë‹¤.

ì´ì œ DBì— recordë¥¼ í•˜ë‚˜ insertí•´ë³´ì.

```sql
insert into member(name) values('spring');
insert into member(name, pwd, phone) values('spring2', 12345, '01012341234');
```

ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. <img src="https://images.velog.io/images/bsu1209/post/337f3f3f-9233-4f19-99f4-ed2078c89805/image.png" width="30%">
- `NOT NULL` íŠ¹ì„±ì„ ë¶€ì—¬í•˜ì§€ ì•Šì•˜ê¸°ì— `null` ê°’ìœ¼ë¡œ ì±„ì›Œì§„ë‹¤.
- í• ë‹¹í•˜ì§€ ì•Šì€ `id` ê°€ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

Database fileì— ëŒ€í•œ ê´€ë¦¬ë¥¼ í•˜ê¸° ìœ„í•´, 
project folderì— `sql` directoryë¥¼ í•˜ë‚˜ ìƒì„±í•œë‹¤.
ê·¸ë¦¬ê³  `sql/ddl.sql` íŒŒì¼ì„ ìƒì„±í•´ ì•„ë˜ì™€ ê°™ì´ sql ë¬¸ë“¤ì„ ì €ì¥í•˜ì—¬ ê´€ë¦¬í•œë‹¤.
<img src="https://images.velog.io/images/bsu1209/post/f19c58a6-43f0-4092-a3a1-4d4979a18b55/image.png" width="80%">

---

## ğŸ” ìˆœìˆ˜ JDBC
êµ¬í˜„í•œ applicationì—ì„œ H2 Databaseì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ë„ë¡ í•œë‹¤.

### â› í™˜ê²½ ì„¤ì •
`build.gradle` íŒŒì¼ì— **jdbc, h2 db ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬**ë¥¼ ì¶”ê°€í•œë‹¤.

```java
dependencies {
	...
	implementation 'org.springframework.boot:spring-boot-starter-jdbc'
	runtimeOnly 'com.h2database:h2'
}
```

- JavaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ DBì™€ì˜ ì—°ë™ì„ ìœ„í•´ì„œëŠ” JDBC driverê°€ í•„ìˆ˜ì ì´ë‹¤.
- DBì™€ì˜ ì—°ë™ì—ì„œ, DBê°€ ì œê³µí•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ í•„ìš”í•œë°, H2ê°€ ê·¸ ì—­í• ì„ í•œë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ DBì— ì ‘ì†í•˜ë ¤ë©´, ì ‘ì† ì •ë³´ê°€ í•„ìš”í•˜ë‹¤.
ì˜ˆì „ì—ëŠ” ê°œë°œìê°€ ì¼ì¼ì´ ì •ë³´ë¥¼ ì…ë ¥í•´ì•¼ í–ˆì§€ë§Œ, **Spring** ì€ ê²½ë¡œ ì •ë³´ë§Œì„ ì´ìš©í•˜ì—¬ ì´ë¥¼ ì²˜ë¦¬í•´ì¤€ë‹¤.

`src/main/resources/application.properties`

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
```

- `h2.Driver` ì— ì—ëŸ¬ê°€ ëœ°í…ë°, ì•„ê¹Œ ìˆ˜ì •í•œ `build.gradle` ì˜ ë³€ê²½ì‚¬í•­ì´ ì ìš©ë˜ì§€ ì•Šì•„ ê·¸ëŸ° ê²ƒì´ë¯€ë¡œ, `Load Gradle Changes` ë¥¼ í•´ì£¼ë©´ ëœë‹¤.
- ê·¸ë¦¬ê³  ìŠ¤í”„ë§ 2.4ë¶€í„°ì˜ ë³€ê²½ì‚¬í•­ìœ¼ë¡œ, `spring.datasource.username=sa` ë¥¼ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ `org.h2.jdbc.JdbcSQLInvalidAuthorizationSpecException: Wrong user name or password [28000-200]` ì´ë¼ëŠ” **ì—ëŸ¬**ê°€ ë°œìƒí•œë‹¤.

### â› JDBC Repository êµ¬í˜„
í˜„ì¬, íšŒì›ì„ ì €ì¥, ì¡°íšŒí•˜ëŠ” ì—­í• ì€ `MemberRepository` ì—ì„œ ìˆ˜í–‰í•˜ì§€ë§Œ,
êµ¬í˜„ì€ **Memory** ì— í•˜ëŠ” ë°©ì‹ì´ê¸°ì— `MemoryMemberRepository` ë¥¼ ì‚¬ìš©í–ˆì—ˆë‹¤.
í•˜ì§€ë§Œ ì´ì œ H2 DBì™€ ì—°ë™í•˜ì—¬ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œ ìƒˆë¡œìš´ Classë¥¼ ìƒì„±í•œë‹¤.

`repository/JdbcMemberRepository.java`

**DataSource**<br/>
ë¨¼ì €, DBì™€ ì—°ë™í•˜ì—¬ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ `DataSource` ë¼ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.
ê·¸ë¦¬ê³ , ì´ë¥¼ springìœ¼ë¡œë¶€í„° **ì£¼ì…**ë°›ì•„ì•¼ í•œë‹¤. 
- springbootëŠ” ìš°ë¦¬ê°€ settingí•œ ì ‘ì† ì •ë³´ë¥¼ ê°€ì§€ê³  `DataSource` ë¥¼ ìƒì„±í•œë‹¤. ê·¸ë¦¬ê³  ì´ë¥¼ ì£¼ì…ë°›ëŠ” ê²ƒì´ë‹¤.

```java
import javax.sql.DataSource;
...

private final DataSource dataSource;

public JdbcMemberRepository(DataSource dataSource) {
    this.dataSource = dataSource;
}
```

### Connection
```java
private Connection getConnection() {
    return DataSourceUtils.getConnection(dataSource);
}
```
- ìœ„ì™€ ê°™ì´ Springì„ í†µí•´ì„œ `getConnection` ì„ ìˆ˜í–‰í•œë‹¤.
	
    - ì´ë ‡ê²Œ í•˜ëŠ” ì´ìœ ëŠ” ê³„ì† ìƒˆë¡œìš´ `Connection` ì´ ìƒì„±ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ì—¬ íŠ¸ëœì­ì…˜ì— ëŒ€í•œ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œì´ë‹¤.
    - releaseë„ ë™ì¼í•˜ê²Œ ìˆ˜í–‰í•œë‹¤.

**save()**<br/>
```java
@Override
public Member save(Member member) {
    String sql = "insert into member(name, pwd, phone) values(?, ?, ?)";
    Connection conn = null;
    PreparedStatement pstmt = null;
    ResultSet rs = null;
    try {
        conn = getConnection();
        pstmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
        pstmt.setString(1, member.getName());
        pstmt.setInt(2, member.getPwd());
        pstmt.setString(3, member.getPhone());
        pstmt.executeUpdate();
        rs = pstmt.getGeneratedKeys();
        if (rs.next()) {
            member.setId(rs.getLong(1));
        } else {
            throw new SQLException("id ì¡°íšŒ ì‹¤íŒ¨");
        }
        return member;
    } catch (Exception e) {
        throw new IllegalStateException(e);
    } finally {
        close(conn, pstmt, rs);
    }
}
```

- `String sql` ì€ ì‚¬ìš©í•  queryì˜ formatì„ ë‹´ê³  ìˆë‹¤.
	
    - `PreparedStatement` ë¥¼ í†µí•´, ì¸ìë¥¼ queryë¬¸ì— ë‹´ì•„ DBì— ì „ë‹¬í•œë‹¤.
- `ResultSet` ì€ ê²°ê³¼ë¥¼ ë°›ì•„ì˜¤ëŠ” ê°ì²´ì´ë‹¤.
- `Statement.RETURN_GENERATED_KEYS` : DBì— insertí•  ë•Œ, `id` ì— keyê°’ì„ í• ë‹¹í•´ì£¼ê¸° ìœ„í•´ í•„ìš”í•œ ì˜µì…˜
- `pstmt.setString(1, member.getName());` ë¡œ queryì— ì¸ìë¥¼ ì¶”ê°€í•´ì£¼ê³ , `pstmt.executeUpdate();` ë¡œ queryë¥¼ ìˆ˜í–‰í•œë‹¤.
- `rs = pstmt.getGeneratedKeys();` ëŠ” ìœ„ì—ì„œ ì„¤ì •í•œ ì˜µì…˜ê³¼ í•¨ê»˜ ì‚¬ìš©ë˜ì–´ì•¼ í•œë‹¤. ì´ëŠ” ìƒì„±í•œ `Key` ë¥¼ ë°˜í™˜í•œë‹¤.
- `rs.next()` ë¡œ `ResultSet` ì— ìˆëŠ” ê°’ì„ êº¼ë‚¼ ìˆ˜ ìˆë‹¤.
- `try - catch` êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ `exception` ì— ëŒ€í•œ ì²˜ë¦¬ë¥¼ í•´ì£¼ê³ , ë§ˆì§€ë§‰ì—ëŠ” ì‚¬ìš©í•œ ìì›ë“¤ (`Connection`, `PreparedStatement`, `ResultSet`) ì— ëŒ€í•œ **release** ë¥¼ í•´ì•¼ í•œë‹¤.

**findById(), findByName(), findByPhone()**<br/>
> ê°€ë§Œíˆ ìƒê°í•´ë³´ë‹ˆ, `findByPwd()` ë¼ëŠ” methodê°€ í•„ìš”í• ê¹Œ? ë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤.
ë¹„ë°€ë²ˆí˜¸ë¥¼ ê°€ì§€ê³  íšŒì›ì„ ì¡°íšŒí•˜ëŠ” ì¼ì€ ë³¸ ì ì´ ì—†ëŠ” ê²ƒ ê°™ì•„ íê¸°ì²˜ë¶„í•œë‹¤.

ì¡°íšŒ ê¸°ëŠ¥ì€ ë§¤ìš° ë¹„ìŠ·í•˜ê¸° ë•Œë¬¸ì— `findById()` ë§Œì„ ì„¤ëª…í•œë‹¤.

```java
@Override
public Optional<Member> findById(Long id) {
    String sql = "select * from member where id = ?";
    Connection conn = null;
    PreparedStatement pstmt = null;
    ResultSet rs = null;
    try {
        conn = getConnection();
        pstmt = conn.prepareStatement(sql);
        pstmt.setLong(1, id);
        rs = pstmt.executeQuery();
        if(rs.next()) {
            Member member = new Member();
            member.setId(rs.getLong("id"));
            member.setName(rs.getString("name"));
            member.setPwd(rs.getInt("pwd"));
            member.setPhone(rs.getString("phone"));
            return Optional.of(member);
        } else {
            return Optional.empty();
        }
    } catch (Exception e) {
        throw new IllegalStateException(e);
    } finally {
        close(conn, pstmt, rs);
    }
}
```

- ë™ì¼í•˜ê²Œ `Connection` ì„ ìˆ˜í–‰í•˜ê³ , queryë¥¼ ë‚ ë¦°ë‹¤.
- `save()` ì™€ëŠ” ë‹¤ë¥´ê²Œ **SELECT** queryì´ë¯€ë¡œ `executeQuery()` ë¥¼ ì‚¬ìš©í•œë‹¤.
- ë°˜í™˜ë˜ëŠ” ê°’ì´ ìˆëŠ” ê²½ìš°, ìƒˆë¡œìš´ `Member` ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ì´ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤.

**findAll()**<br/>
`findAll()` ì€ í†µì§¸ë¡œ ì¡°íšŒí•˜ëŠ” ê²ƒì´ë¯€ë¡œ ì¡°ê±´ì´ ìˆëŠ” `findBy~()` ë³´ë‹¤ ë‹¨ìˆœí•œ êµ¬ì¡°ì´ë‹¤.

```java
@Override
public List<Member> findAll() {
    String sql = "select * from member";
    Connection conn = null;
    PreparedStatement pstmt = null;
    ResultSet rs = null;
    try {
        conn = getConnection();
        pstmt = conn.prepareStatement(sql);
        rs = pstmt.executeQuery();
        List<Member> members = new ArrayList<>();
        while(rs.next()) {
            Member member = new Member();
            member.setId(rs.getLong("id"));
            member.setName(rs.getString("name"));
            member.setPwd(rs.getInt("pwd"));
            member.setPhone(rs.getString("phone"));
            members.add(member);
        }
        return members;
    } catch (Exception e) {
        throw new IllegalStateException(e);
    } finally {
        close(conn, pstmt, rs);
    }
}
```

- `List<Member>` í˜•íƒœë¡œ ë°˜í™˜ë°›ê¸° ë•Œë¬¸ì—, `while()` ì„ ì´ìš©í•˜ì—¬ ê²°ê³¼ Listë¥¼ ë°˜í™˜í•œë‹¤.

**close()**<br/>
ì‚¬ìš©í•œ ìì›ì— ëŒ€í•œ releaseëŠ” **ì—­ìˆœ** ìœ¼ë¡œ ì§„í–‰í•œë‹¤.

```java
private void close(Connection conn, PreparedStatement pstmt, ResultSet rs) {

    try {
        if (rs != null) {
            rs.close();
        }
    } catch (SQLException e) {
        e.printStackTrace();
    }

    try {
        if (pstmt != null) {
            pstmt.close();
        }
    } catch (SQLException e) {
        e.printStackTrace();
    }

    try {
        if (conn != null) {
            close(conn);
        }
    } catch (SQLException e) {
        e.printStackTrace();
    }
}

private void close(Connection conn) throws SQLException {
    DataSourceUtils.releaseConnection(conn, dataSource);
}
```

### â› Configuration
ì´ì „ì— `MemoryMemberRepository` ë¡œ êµ¬í˜„í–ˆì„ ë•Œ, `SpringConfig` fileì—ì„œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— `MemoryMemberRepository` ë¥¼ ë“±ë¡í•˜ëŠ” ì‘ì—…ì„ ê±°ì³¤ë‹¤.

ì´ë¥¼ ë°©ê¸ˆ ìƒì„±í•œ `JdbcMemberRepository` ë¥¼ ë“±ë¡í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³€ê²½í•œë‹¤.
ê·¸ë¦¬ê³  `JdbcMemberRepository` ëŠ” `DataSource dataSource` ë¥¼ í•„ìš”ë¡œ í•œë‹¤.
ì´ëŠ” Springì—ì„œ ì œê³µí•´ì£¼ëŠ”ë°, ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ì´ ìˆë‹¤.

`SpringConfig`

```java
Autowired DataSource dataSource;

or

private DataSource dataSource;

@Autowired
public SpringConfig(DataSource dataSource) {
    this.dataSource = dataSource;
}
```

- ìœ„ ì„¤ì •ì„ í†µí•´, Springì´ `DataSource dataSource` ì— ëŒ€í•œ Beanì„ ìƒì„±í•´ ì˜ì¡´ì„± ì£¼ì…ì„ ìˆ˜í–‰í•´ì¤€ë‹¤.

**`SpringConfig` ë§Œì„ ë³€ê²½ì‹œí‚´ìœ¼ë¡œì¨, ìˆ˜ì •ëœ ì½”ë“œì— ëŒ€í•œ ì˜ì¡´ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤.**

`./h2.sh` ë¡œ H2 DBë¥¼ ë™ì‘ì‹œí‚¤ê³ , ìŠ¤í”„ë§ì„ ë™ì‘ì‹œì¼œ íšŒì› ë“±ë¡ ë° ëª©ë¡ ì¡°íšŒë¥¼ í•˜ë©´, DBì™€ ì—°ë™í•˜ì—¬ ì •ìƒì ìœ¼ë¡œ ë“±ë¡, ì¡°íšŒê°€ ì´ë£¨ì–´ì§€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

> **Springì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ **
- ë‹¤í˜•ì„±ì˜ í™œìš©: ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‘ê³ , êµ¬í˜„ì²´ë¥¼ ë°”ê¿”ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì´ëŠ” ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ DIë¥¼ ì´ìš©í•´ ì§€ì›í•œë‹¤. (memoryRepository â†’ JdbcRepository)

ì•„ë˜ëŠ” êµ¬í˜„ í´ë˜ìŠ¤ì— ëŒ€í•œ ì„¤ëª…ì„ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•œ ê²ƒì´ë‹¤.
<img src="https://images.velog.io/images/bsu1209/post/5e08e10a-9ded-4a7d-a7e5-fe21049d30e1/springboot-Page-3.drawio.png" width="80%">

ì•„ë˜ëŠ” ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ì„œ êµ¬í˜„ í´ë˜ìŠ¤ì™€ì˜ ì—°ê²°ì„ í‘œí˜„í•œ ê·¸ë¦¼ì´ë‹¤.
<img src="https://images.velog.io/images/bsu1209/post/9b48be9a-7bb1-4cca-bd94-efabe6dc9d13/springboot-Page-2.drawio%20(3).png" width="80%">

- ì´ì™€ ê°™ì€ êµ¬ì¡°ë¥¼ **ê°œë°©-íì‡„ ì›ì¹™(OCP, Open-Close-Principle)** ì„ ë”°ë¥¸ë‹¤ê³  í•œë‹¤.
	
    - í™•ì¥ì—ëŠ” ì—´ë ¤ìˆê³ , ìˆ˜ì •(ë³€ê²½)ì—ëŠ” ë‹«í˜€ìˆë‹¤.
    - ê°ì²´ì§€í–¥ì˜ **ë‹¤í˜•ì„±**ì´ë¼ëŠ” ê°œë…ì„ ì˜ í™œìš©í•˜ë©´, applicationì˜ ë™ì‘ ì½”ë“œë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³ ë„ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.
- ìœ„ì™€ ê°™ì´ **ìŠ¤í”„ë§ì˜ DI**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì •(`SpringConfig`)ë§Œìœ¼ë¡œ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.

---

## ğŸ” ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸
ì´ì „ì— ì‘ì„±í•œ `MemoryMemberRepositoryTest` ì˜ ì½”ë“œë“¤ì€ ìŠ¤í”„ë§ê³¼ëŠ” ê´€ë ¨ì—†ì´ ìˆœìˆ˜í•˜ê²Œ ìë°” ì½”ë“œë§Œìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•œ ê²ƒì´ë‹¤.
`test/.../MemberServiceTest.java`
ìˆœìˆ˜í•œ ìë°” ì½”ë“œì˜€ê¸°ì—, JVM ì•ˆì—ì„œ ì‹¤í–‰ë˜ì–´ ë¹ ë¥´ê²Œ ì‹¤í–‰ëœë‹¤.

ì´ì œëŠ” DBê¹Œì§€ ì—°ê²°í•œ **ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸**ë¥¼ ìˆ˜í–‰í•´ë³´ë„ë¡ í•œë‹¤.

ìš°ì„  ì´ì „ì˜ `MemberServiceTest.java` ë¥¼ ë³µì‚¬í•˜ì—¬`MemberServiceIntegrationTest.java` ë¥¼ ìƒì„±í•œë‹¤.
```java
package hello.hellospring.service;

import hello.hellospring.domain.Member;
import hello.hellospring.repository.MemberRepository;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertThrows;

@SpringBootTest
@Transactional
class MemberServiceIntegrationTest {

    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;

    @Test
    void íšŒì›ê°€ì…() {
        // given
        Member member = new Member();
        member.setName("spring");

        // when
        Long saveId = memberService.join(member);

        // then
        Member findMember = memberService.findOne(saveId).get();
        assertThat(member.getName()).isEqualTo(findMember.getName());
    }

    @Test
    public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() {
        // given
        Member member1 = new Member();
        member1.setName("spring");

        Member member2 = new Member();
        member2.setName("spring");

        // when
        memberService.join(member1);
        IllegalStateException e = assertThrows(IllegalStateException.class, () -> memberService.join(member2));

        assertThat(e.getMessage()).isEqualTo("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");

        // then
    }
}
```

- `@BeforeEach` annotationì„ ì‚¬ìš©í•˜ëŠ” methodë¥¼ ì‚­ì œí•œë‹¤.
	
    - ì´ì œëŠ” ê°ì²´ë¥¼ ì§ì ‘ ìƒì„±í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¡œë¶€í„° ë°›ì•„ì™€ì•¼ í•˜ê¸° ë•Œë¬¸ì— ìƒì„±ìë¥¼ ì´ìš©í•˜ì—¬ ì˜ì¡´ì„± ì£¼ì…ì„ ìˆ˜í–‰í•´ì•¼ í•œë‹¤.
    - í•˜ì§€ë§Œ, **Test** ëŠ” ê°œë°œì˜ ì œì¼ ëë‹¨ì— ìˆë‹¤ê³  í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤. (fieldê¸°ë°˜ì˜ `@Autowired` ë¥¼ ì‚¬ìš©)
- `MemoryMemberRepository` ê°€ ì•„ë‹ˆë¼ `MemberRepository` ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.
	
    - `SpringConfig` ë¥¼ í†µí•´ êµ¬í˜„ì²´ê°€ ì˜¬ë¼ì™”ê¸° ë•Œë¬¸ì´ë‹¤?
- Testë¥¼ ìˆ˜í–‰í•˜ëŠ” ë™ì•ˆ, ì´ì „ Test methodì˜ ì˜í–¥ì„ ì—†ì• ê¸° ìœ„í•´ ì‚¬ìš©í–ˆë˜ `@AfterEach` methodë¥¼ ì‚­ì œí•œë‹¤.
	
    - ì´ëŠ” **`@Transactional`** ì˜ ì¡´ì¬ë¡œ í•„ìš”ê°€ ì—†ì–´ì¡Œë‹¤.
    - `@Transactional` ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê³  íšŒì›ê°€ì… Testë¥¼ ìˆ˜í–‰í•˜ë©´, Testê°€ ëë‚œ ì´í›„ì—ë„, DBì— í…ŒìŠ¤íŠ¸ ê°€ì…í•œ íšŒì›ì˜ ì •ë³´ê°€ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆë‹¤.
    	- **Testë¥¼ ë°˜ë³µ ìˆ˜í–‰**í•˜ê²Œ ë˜ë©´, **ì—ëŸ¬**ê°€ ëœ¨ê²Œ ëœë‹¤.
    - í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” DBì— ì—°ê²°í•˜ì—¬ `select, insert` ë“±ì˜ queryë¥¼ ë‚ ë¦° í›„, `rollback` í•˜ì—¬ DB ìˆ˜ì •ì‚¬í•­ì„ ë˜ëŒë¦¬ëŠ” ë¡œì§ì´ í•„ìš”í•˜ë‹¤.
    - `@Transactional` annotationdì„ Test caseì— ë‹¬ë©´, Test ì‹¤í–‰ ì „, **Transaction** ì„ ì‹¤í–‰í•œ í›„, Testê°€ ëë‚  ë•Œ **rollback** ì„ ìˆ˜í–‰í•œë‹¤. ë”°ë¼ì„œ, DBëŠ” ë°˜ë³µ ìˆ˜í–‰ì—ë„ ë¬¸ì œê°€ ì—†ëŠ” ìƒíƒœê°€ ëœë‹¤.

Testë¥¼ ì‹¤í–‰í•˜ë©´, consoleì„ í™•ì¸í•˜ì—¬ **Spring** ì´ í•¨ê»˜ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. (`@SpringBootTest`)
- `SpringConfig` ì— ì‘ì„±í•œ ë‚´ìš©ë„ í•¨ê»˜ ì˜¬ë¼ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
> Testë¥¼ ì‹¤í–‰í•  ë•Œ, ì´ë¯¸ DBì— ì €ì¥ë˜ì–´ ìˆëŠ” ì •ë³´ì™€ ê²¹ì³ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ìœ ì˜í•œë‹¤.

> ê·¸ëŸ¼ ì´ì „ì— êµ¬í˜„í•œ `MemberServiceTest` ëŠ” í•„ìš”ê°€ ì—†ëŠ”ê°€?
>> `MemberServiceTest` ëŠ” **"ë‹¨ìœ„ í…ŒìŠ¤íŠ¸"**,
 `MemberServiceIntegrationTest` ëŠ” **"í†µí•© í…ŒìŠ¤íŠ¸"** ë¼ê³  í•œë‹¤.
- ê°€ê¸‰ì ìœ¼ë¡œ, **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ê°€ í›¨ì”¬ ì¢‹ì€ í…ŒìŠ¤íŠ¸ì¼ í™•ë¥ ì´ ë†’ë‹¤.** ì»¨í…Œì´ë„ˆê¹Œì§€ ì˜¬ë ¤ì•¼ í•˜ëŠ” í…ŒìŠ¤íŠ¸ì¸ ê²½ìš° í…ŒìŠ¤íŠ¸ ì„¤ê³„ê°€ ì˜ëª»ë˜ì—ˆì„ í™•ë¥ ì´ ë†’ë‹¤.

---

## ğŸ” ìŠ¤í”„ë§ JdbcTemplate
JDBC APIì—ì„œì˜ ë°˜ë³µì ì¸ ì½”ë“œë¥¼ ì œê±°í•´ì¤€ë‹¤. í•˜ì§€ë§Œ SQL queryëŠ” ì§ì ‘ ì‘ì„±í•´ì•¼ í•œë‹¤.

`repository/JdbcTemplateMemberRepository.java`
```java
package hello.hellospring.repository;

import hello.hellospring.domain.Member;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;

import javax.sql.DataSource;
import java.util.List;
import java.util.Optional;

public class JdbcTemplateMemberRepository implements MemberRepository {

    private final JdbcTemplate jdbcTemplate;

    // @Autowired ìƒëµ ê°€ëŠ¥
    public JdbcTemplateMemberRepository(DataSource dataSource) {
        this.jdbcTemplate = new JdbcTemplate(dataSource);
    }

    ...
}
```

- `JdbcTemplate` ì´ ì¡´ì¬í•˜ë¯€ë¡œ, ì´ë¥¼ ì‚¬ìš©í•œë‹¤. ì´ëŠ” Injectionì„ ë°›ì„ ìˆ˜ ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼ `DataSource` ê°€ í•„ìš”í•˜ë‹¤.
	
    > classì˜ ìƒì„±ìê°€ ë”± 1ê°œì¸ ê²½ìš°, Spring beanìœ¼ë¡œ ë“±ë¡ ì‹œ, `@Autowired` ë¥¼ ìƒëµí•  ìˆ˜ ìˆë‹¤.
    
### â› `RowMapper` method
```java
private RowMapper<Member> memberRowMapper() {
    return (rs, rowNum) -> {
        Member member = new Member();
        member.setId(rs.getLong("id"));
        member.setName(rs.getString("name"));
        member.setPwd(rs.getInt("pwd"));
        member.setPhone(rs.getString("phone"));
        return member;
    };
}
```

- íšŒì› ì •ë³´ ì¡°íšŒì˜ ê²°ê³¼ë¥¼ ë°›ì•„ì˜¤ê¸° ìœ„í•´ì„œ `RowMapper` ë¼ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.
	
    - `RowMapper` ëŠ” queryì˜ ê²°ê³¼ë¥¼ ê°ì²´ë¡œ ë°›ì•„ì˜¨ë‹¤. ì´ì „ì—ëŠ” `ResultSet` ì— ê²°ê³¼ë¥¼ ë°›ê³ , ì´ë¥¼ ê°ì²´ë¡œ ìƒì„±í•´ì„œ ë°˜í™˜í•˜ëŠ” ê³¼ì •ì„ ê±°ì³¤ì§€ë§Œ `RowMapper` ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `ResultSet` ì„ ì‚¬ìš©í•˜ì—¬ ìœ„ ê³¼ì •ì„ ìˆ˜í–‰í•œë‹¤.
   
### â› íšŒì› ì •ë³´ ì¡°íšŒ

```java
@Override
public Optional<Member> findById(Long id) {
    List<Member> result = jdbcTemplate.query("select * from member where id = ?", memberRowMapper(), id);
    return result.stream().findAny();
}
```

- ì…ë ¥ë°›ì€ `id` ê°’ì„ `?` ìë¦¬ì— ì¹˜í™˜í•˜ê³ , ê²°ê³¼ë¥¼ `memberRowMapper()` ë¥¼ í†µí•´ ë°›ì•„ì˜¨ë‹¤.
- ê²°ê³¼ì˜ ë°˜í™˜í˜•ì´ `List<Member>` ì´ë¯€ë¡œ `result` ì— ë°›ê³ , ê²°ê³¼ë¥¼ `Optional<>` ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜í•œë‹¤.

### â› íšŒì› ì •ë³´ ì¡°íšŒ (`findAll`)

```java
@Override
public List<Member> findAll() {
    return jdbcTemplate.query("select * from member", memberRowMapper());
}
```

### â› íšŒì›ê°€ì…

```java
@Override
public Member save(Member member) {
    SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
    jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");
    Map<String, Object> parameters = new HashMap<>();
    parameters.put("name", member.getName());
    parameters.put("pwd", member.getPwd());
    parameters.put("phone", member.getPhone());
    Number key = jdbcInsert.executeAndReturnKey(new MapSqlParameterSource(parameters));
    member.setId(key.longValue());
    return member;
}
```

- `SimpleJdbcInsert` ë¥¼ ì‚¬ìš©í•˜ì—¬ queryë¥¼ ì§¤ í•„ìš” ì—†ì´ êµ¬í˜„ì´ ê°€ëŠ¥í•˜ë‹¤.
	
    - TableName, PK, ì…ë ¥ê°’ë§Œ ìˆìœ¼ë©´ `insert` ëŠ” êµ¬í˜„ ê°€ëŠ¥í•˜ê¸°ì— ì‚¬ìš©í•œë‹¤.
- `executeAndReturnKey` ë¥¼ ì´ìš©í•´ ìƒì„±í•œ íšŒì›ì˜ `key` ë¥¼ ë°›ê³  ì´ë¥¼ ì €ì¥í•œ `Member` ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤.

## `SpringConfig`
ì´ì œ êµ¬í˜„í•œ DB ì ‘ê·¼ classë¥¼ ì—°ê²°í•˜ê¸° ìœ„í•œ ì„¤ì •ì„ í•œë‹¤.

```java
@Bean
public MemberRepository memberRepository() {
    //return new JdbcMemberRepository(dataSource);
    return new JdbcTemplateMemberRepository(dataSource);
}
```

ì´ì œëŠ” **ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸**ë¥¼ êµ¬í˜„í–ˆê¸° ë•Œë¬¸ì— Web Applicationì„ ì‹¤í–‰í•  í•„ìš” ì—†ì´ DBë§Œ ì ‘ì†í•˜ê³  í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ìˆ˜í–‰í•˜ë©´ ëœë‹¤.

---

## ğŸ” JPA
**JdbcTemplate** ì„ ì‚¬ìš©í•˜ì—¬ ë°˜ë³µì ì¸ ì½”ë“œë¥¼ ë§ì´ ì¤„ì¸ ê²ƒì€ ë§ì§€ë§Œ, ì—¬ì „íˆ SQL queryëŠ” ê°œë°œìê°€ ì§ì ‘ ì‘ì„±í•´ì•¼ í•œë‹¤.

ì´ë²ˆ ì¥ì—ì„œëŠ” Interfaceì˜ ì¼ì¢…ì¸ **JPA** ë¥¼ ì‚¬ìš©í•˜ì—¬ query ë˜í•œ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë„ë¡ í•œë‹¤. ì´ë¥¼ í†µí•´
- SQLê³¼ Data ì¤‘ì‹¬ì˜ ì„¤ê³„ â†’ ê°ì²´ ì¤‘ì‹¬ì˜ ì„¤ê³„ (íŒ¨ëŸ¬ë‹¤ì„ì˜ ì „í™˜)
- ê°œë°œ ìƒì‚°ì„±ì˜ ì¦ëŒ€

`build.gradle`
```java
dependencies {
    ...
    //	implementation 'org.springframework.boot:spring-boot-starter-jdbc'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa' 
    runtimeOnly 'com.h2database:h2'
    testImplementation('org.springframework.boot:spring-boot-starter-test') {
        exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'
    }
}
```

`application.properties`

JPAì™€ ê´€ë ¨ëœ ì„¤ì •ì„ ì¶”ê°€í•œë‹¤.

```java
spring.jpa.show-sql=true
spring.jpa.hibernate.ddl-auto=none
```

- `show-sql=true` : JPAê°€ ìƒì„±í•˜ëŠ” sqlì„ ë³¼ ìˆ˜ ìˆë‹¤.
- `ddl-auto=none` : JPAëŠ” ê°ì²´ë¥¼ í™•ì¸í•˜ê³  ì´ì— ëŒ€í•œ Tableì„ ìƒì„±í•œë‹¤. í•˜ì§€ë§Œ ì´ë¯¸ Tableì„ ìƒì„±í–ˆê³ , ìƒì„±í•œ Tableì„ ì‚¬ìš©í•  ê²ƒì´ë¯€ë¡œ, í•´ë‹¹ ê¸°ëŠ¥ì„ `none` ì„¤ì •í•œë‹¤.

> JPAëŠ” ìë°” í‘œì¤€ì˜ interfaceì´ë‹¤. ê·¸ë˜ì„œ êµ¬í˜„ì€ ì—¬ëŸ¬ vendorë“¤ì´ ìˆ˜í–‰í•œë‹¤. ì—¬ê¸°ì„œëŠ” `hibernate` libraryë¥¼ ì¤‘ì ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„í•œë‹¤.

> JPAëŠ” ê°ì²´ì™€ ORMì´ë¼ëŠ” ê¸°ìˆ ì„ ì‚¬ìš©í•œë‹¤. Object Relational Mapping, ì—¬ê¸°ì„œ Mappingì€ annotationì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰í•œë‹¤.

JPAë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” **Entity Mapping** ì´ í•„ìš”í•˜ë‹¤.

`domain/Member.java`
```java
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;

@Entity
public class Member {
    
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    ...
```

- `@Entity` : JPAê°€ ê´€ë¦¬í•  Entityì„ì„ ëª…ì‹œí•œë‹¤.
- `@Id` : primary keyë¡œ ì§€ì •í•œë‹¤.
- `@GeneratedValue(strategy = GenerationType.IDENTITY)` : DBì—ì„œ ê³ ìœ í•˜ê²Œ ê°’ì„ ìë™ìœ¼ë¡œ ìƒì„±í•œë‹¤. ì‚¬ìš©ìê°€ insertí•˜ì§€ ì•ŠëŠ”ë‹¤.
- ë§Œì•½ DBì— ì €ì¥ë  columnëª…ì„ ìˆ˜ì •í•˜ê³  ì‹¶ë‹¤ë©´, ì•„ë˜ì™€ ê°™ì€ annotationì„ ìƒì„±í•œë‹¤.
```java
@Column(name = "ì›í•˜ëŠ” columnëª…")
private String name;
```

ì´ì œ repositoryë¥¼ ìƒì„±í•œë‹¤.

`repository/JpaMemberRepository.java`
```java
public class JpaMemberRepository implements MemberRepository {

    private final EntityManager em;

    public JpaMemberRepository(EntityManager em) {
        this.em = em;
    }
    
    ...
```

- `EntityManager` : JPAëŠ” `EntityManager` ë¥¼ í†µí•´ ëª¨ë“  ê²ƒì´ ë™ì‘í•œë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•œ `data-jpa` dependencyë¥¼ í†µí•´ JPAê°€ ìë™ìœ¼ë¡œ í˜„ì¬ DBì™€ ì—°ê²°ëœ `EntityManager` ë¥¼ ìƒì„±í•œë‹¤. ë”°ë¼ì„œ ì´ë¥¼ **Injection** ë°›ì•„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

### â› save()
```java
@Override
public Member save(Member member) {
    em.persist(member);
    return member;
}
```

- `em.persist(member)` : ê°ì²´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ queryë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ ì‘ì„±í•œë‹¤.

### â› findById
```java
@Override
public Optional<Member> findById(Long id) {
    Member member = em.find(Member.class, id);
    return Optional.ofNullable(member);
}
```

- `em.find(Member.class, id)` : ì¡°íšŒí•  Typeê³¼ ì‹ë³„ìë¥¼ ì „ë‹¬í•˜ì—¬ ì¡°íšŒí•œë‹¤.
- ë°˜í™˜í˜•ì´ `Optional` ì´ë¯€ë¡œ ì´ì— ë§ê²Œ ë°˜í™˜í•œë‹¤.

### â› findAll
**JPQLì´ë¼ëŠ” ê°ì²´ ì§€í–¥ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©**í•œë‹¤.

```java
@Override
public List<Member> findAll() {
    return em.createQuery("select m from Member m", Member.class)
            .getResultList();
}
```

- Tableì„ ëŒ€ìƒìœ¼ë¡œ queryë¥¼ ë³´ë‚´ëŠ” ê²ƒì´ ì•„ë‹Œ, ê°ì²´(Entity, ex. `Member`)ë¥¼ ëŒ€ìƒìœ¼ë¡œ queryë¥¼ ë³´ë‚´ ì‚¬ìš©í•œë‹¤. ì´ëŸ¬í•œ queryê°€ SQLë¡œ ë²ˆì—­ëœë‹¤.
- `select` ì˜ ëŒ€ìƒì´ íŠ¹ì • attributeê°€ ì•„ë‹Œ **Entity ìì²´**ì´ë‹¤.

### â› findByName
**JPQLì´ë¼ëŠ” ê°ì²´ ì§€í–¥ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©**í•œë‹¤.

```java
@Override
public Optional<Member> findByName(String name) {
    List<Member> result = em.createQuery("select m from Member m where m.name = :name", Member.class)
            .setParameter("name", name)
            .getResultList();
        
    return result.stream().findAny();
}
```

**PK ê¸°ë°˜ì˜ queryê°€ ì•„ë‹Œ ê²½ìš°ì—ëŠ” JPQLì„ ì‘ì„±í•´ì•¼ í•œë‹¤.**

JPAëŠ” ëª¨ë“  ë°ì´í„°ì˜ ë³€ê²½ì´ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì´ë¤„ì ¸ì•¼ í•œë‹¤. ë”°ë¼ì„œ JPAë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” **í•­ìƒ Transactionalì´ ì¡´ì¬**í•´ì•¼ í•œë‹¤.

`service/MemberService.java` ì— `@Transactional` ì„ ì¶”ê°€í•˜ëŠ”ë°,
class ìì²´ì— í•´ì¤˜ë„ ë˜ê³ , íšŒì› ê°€ì… ì‹œì—ë§Œ ë™ì‹œì„± ì œì–´ê°€ í•„ìš”í•˜ë¯€ë¡œ `Long join()` methodì—ë§Œ ì¶”ê°€í•´ì¤˜ë„ ëœë‹¤.

ì´ì œ `SpringConfig` ì— ì„¤ì •ì„ ì¶”ê°€í•´ì¤˜ì•¼ í•œë‹¤.
```java
private EntityManager em;
    
@Autowired
public SpringConfig(EntityManager em) {this.em = em;}

@Bean
public MemberRepository memberRepository() {
    //return new JdbcMemberRepository(dataSource);
    //return new JdbcTemplateMemberRepository(dataSource);
    return new JpaMemberRepository(em);
}
```

- `JpaMemberRepository` ëŠ” `EntityManager` ë§Œì„ í•„ìš”ë¡œ í•˜ê¸°ì—, ê¸°ì¡´ì˜ `DataSource` ì™€ ìƒì„±ìëŠ” ì‚­ì œí•œë‹¤.

ì´ì œ ì´ì „ì— êµ¬í˜„í–ˆë˜ **ìŠ¤í”„ë§ í†µí•© Test** ë¡œ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.

ìê¾¸ ì—ëŸ¬ê°€ ë‚œë‹¤...
ì–´ë”˜ê°€ ìˆ˜ì •ì´ í•„ìš”í•˜ë‹¤.

```bash
Hibernate: select member0_.id as id1_0_, member0_.name as name2_0_, member0_.phone as phone3_0_, member0_.pwd as pwd4_0_ from member member0_ where member0_.name=?
Hibernate: select member0_.id as id1_0_, member0_.name as name2_0_, member0_.phone as phone3_0_, member0_.pwd as pwd4_0_ from member member0_ where member0_.name=?
Hibernate: insert into member (id, name, phone, pwd) values (null, ?, ?, ?)
2022-01-11 15:51:29.818  WARN 2434 --- [           main] o.h.engine.jdbc.spi.SqlExceptionHelper   : SQL Error: 23502, SQLState: 23502
2022-01-11 15:51:29.818 ERROR 2434 --- [           main] o.h.engine.jdbc.spi.SqlExceptionHelper   : NULL not allowed for column "ID"; SQL statement:
```

Test methodì— `@Commit` annotationì„ ì‚¬ìš©í•˜ë©´, `@Transactional` ì´ ìˆì–´ë„ rollbackë˜ì§€ ì•Šê³  DBì— ë°˜ì˜ëœë‹¤.

> âœï¸ **ERROR ìˆ˜ì •**
> 
> https://www.inflearn.com/questions/389513 í•´ë‹¹ ë§í¬ë¥¼ ë³´ë©´ì„œ,
> - h2 DBë¥¼ ë‚®ì€ ë²„ì „ìœ¼ë¡œ ìƒˆë¡œ ë°›ê³ , ìƒˆ dbë¥¼ ë§Œë“¤ì–´ì„œ tableì„ ìƒì„±
> - ì´í›„ ì‹¤í–‰í–ˆì„ ë•Œ ë°©ê¸ˆ ìƒì„±í•œ `Member` tableì„ ëª» ì°¾ëŠ”ë‹¤ëŠ” ì—ëŸ¬ê°€ ë– ì„œ `application.properties` ì—ì„œ `spring.jpa.hibernate.ddl-auto = create` ë¡œ ìˆ˜ì •
> - ì—ëŸ¬ fix ì™„ë£Œ ...

---

## ğŸ” ìŠ¤í”„ë§ ë°ì´í„° JPA
ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì´ìš©í•˜ë©´, ì´ì „ì— êµ¬í˜„í•œ **Repositoryì— êµ¬í˜„ì²´ ì—†ì´ë„ Interfaceë§Œìœ¼ë¡œ ê°œë°œì´ ê°€ëŠ¥**í•˜ë‹¤. (**CRUD** ê¸°ëŠ¥ë„ ì œê³µí•œë‹¤!)

> JPAë¥¼ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ë„ë¡ í•´ì£¼ëŠ” ê¸°ìˆ ì´ë¯€ë¡œ JPAì— ëŒ€í•œ ì´í•´ì™€ í•™ìŠµì´ ìˆ˜ë°˜ë˜ì–´ì•¼ í•œë‹¤!

`repository/SpringDataJpaRepository.java` (interface!)

```java
package hello.hellospring.repository;

import hello.hellospring.domain.Member;
import org.springframework.data.jpa.repository.JpaRepository;

public interface SpringDataJpaMemberRepository extends JpaRepository<Member, Long>, MemberRepository {
    @Override
    Optional<Member> findByName(String name);
}
```

- Interfaceê°€ Interfaceë¥¼ ìƒì†ë°›ì„ ë•ŒëŠ” **`extends`** ë¥¼ ì‚¬ìš©í•˜ê³  **ë‹¤ì¤‘ ìƒì†**ì´ ê°€ëŠ¥í•˜ë‹¤.
- `JpaRepository<Member, Long>`
	
    - `Member` : ì‚¬ìš©í•˜ëŠ” Entity
    - `Long` : Entityì˜ ì‹ë³„ì (PK, `id`)
- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” `JpaRepository` ë¥¼ ìƒì†ë°›ì•„ ì‚¬ìš©í•˜ëŠ” interfaceë¥¼ ë°œê²¬í•˜ë©´, `SpringDataJpaRepository` ê°€ ì•Œì•„ì„œ êµ¬í˜„ì²´ë¥¼ ë§Œë“¤ì–´ ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡í•˜ë„ë¡ í•œë‹¤. ê·¸ë˜ì„œ ì´ë¥¼ `SpringConfig` ë¥¼ í†µí•´ ê°€ì ¸ë‹¤ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

`SpringConfig`

```java
private final MemberRepository memberRepository;

public SpringConfig(MemberRepository memberRepository) {
    this.memberRepository = memberRepository;
}

@Bean
public MemberService memberService() {
    return new MemberService(memberRepository);
}

//    @Bean
//    public MemberRepository memberRepository() {
//        //return new JdbcMemberRepository(dataSource);
//        //return new JdbcTemplateMemberRepository(dataSource);
//        //return new JpaMemberRepository(em);
//    }
```

- ì´ë¡œì„œ ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ë§Œë“  êµ¬í˜„ì²´ê°€ ë“±ë¡ëœë‹¤.
- `MemberService` ì— ì˜ì¡´ ê´€ê³„ë¥¼ ì„¤ì •í•œë‹¤.

`SpringConfig` ìƒì„±ìë¡œ ì¸í•´ `MemberRepository` ë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ì„œ íƒìƒ‰í•˜ì§€ë§Œ, ì‚¬ìš©ìê°€ ë“±ë¡í•œ ê²ƒì€ ì—†ë‹¤.
- ê·¸ëŸ¬ë‚˜ ìœ„ì—ì„œ ìƒì„±í•œ **`JpaRepository` ë¥¼ ìƒì†ë°›ëŠ” interface**ë¥¼ í†µí•´ ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ êµ¬í˜„ì²´ë¥¼ ìƒì„±í•´ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤.
- ì´ë ‡ê²Œ ë“±ë¡ëœ `MemberRepository` ë¥¼ `MemberService` ì—ë„ ê·¸ëŒ€ë¡œ ì „ë‹¬í•´ ì‚¬ìš©í•œë‹¤.

### â› ì›ë¦¬
`JpaRepository` ë¥¼ ê¹Œë³´ë©´,
<img src="https://images.velog.io/images/bsu1209/post/48a56b56-bfc9-4b15-8563-8bf0f9cf72cf/image.png" width="80%">

- ê¸°ë³¸ì ì¸ methodë“¤ì´ ì œê³µë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- ê·¸ë¦¬ê³  `JpaRepository` ê°€ ìƒì†ë°›ëŠ” ìƒìœ„ Repositoryë“¤ì„ í™•ì¸í•´ë³´ë©´, `PagingAndSortingRepository` (Paging ê¸°ëŠ¥), `CrudRepository` ê°€ ìˆë‹¤.
	
    - ì¦‰, **ê¸°ë³¸ì ì¸ ë‹¨ìˆœ ì¡°íšŒ, CRUDê°€ ì´ë ‡ê²Œ ì œê³µëœë‹¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.**
    - ê·¸ë˜ì„œ ì´ë“¤ì„ ê°€ì ¸ë‹¤ ì“°ë©´ ë˜ëŠ” ê²ƒì´ë‹¤!
    - í•˜ì§€ë§Œ, ì´ì™€ ê°™ì€ ê³µí†µì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì´ ì•„ë‹Œ ìì²´ì ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” `Optional<Member> findByName(String name);` ê³¼ ê°™ì´ interfaceì— ê¸°ìˆ í•´ì•¼ í•œë‹¤.
    	- ê·œì¹™: `findBy{ }And{ }(String { }, Long { })` ê³¼ ê°™ì€ í˜•íƒœì—¬ì•¼ í•œë‹¤.

> ì‹¤ë¬´ì—ì„œëŠ” **JPA** ì™€ **ìŠ¤í”„ë§ ë°ì´í„° JPA** ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ê³ , ë³µì¡í•œ ë™ì  queryëŠ” **Querydsl** ì´ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤. ì´ëŠ” ìë°” ì½”ë“œë¡œ ì•ˆì „í•˜ê²Œ queryë¥¼ ì‘ì„±í•  ìˆ˜ ìˆê³ , ë™ì  query ë˜í•œ í¸ë¦¬í•˜ê²Œ ì‘ì„±í•˜ë„ë¡ ë•ëŠ”ë‹¤. 

---

## ğŸ“Œ ì¤‘ìš”í•œ ê°œë…
ê°œë°©-íì‡„ ì›ì¹™, ë‹¤í˜•ì„±, @Transactional, JPA

## ğŸ“• ì°¸ê³ 
- [H2 database ê³µì‹ë¬¸ì„œ](https://www.h2database.com/html/main.html)
- [RowMapper](https://velog.io/@seculoper235/RowMapper%EC%97%90-%EB%8C%80%ED%95%B4)
- [ìŠ¤í”„ë§ ì…ë¬¸-ì½”ë“œë¡œ ë°°ìš°ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸, ì›¹ MVC, DB ì ‘ê·¼ ê¸°ìˆ ](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%EC%9E%85%EB%AC%B8-%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8)